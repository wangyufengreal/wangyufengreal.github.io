---
title: 对于工业场景下关键区域模糊导致 OCR 失效问题的分析与解决方案
date: 2025-12-11 08:00:00 +0800
categories: [技术]
tags: [机器视觉]
---

## 问题描述

在某种需要强制检定的计量器具的检定业务领域，使用工业摄像头对表盘信息进行 ocr 文本提取，对条码/二维码进行识别是一种很常见的需求。在这样的场景下，我们提供的识别接口遇到一个问题---部分输入图片出现 ocr/扫码失效的问题，通过初步分析，我们发现表盘关键区域模糊，反而非关键区域对焦清晰，由此导致 ocr 提取不到需要的关键信息（表号，规格等），同样的条码/二维码区域也是模糊的，导致扫码同样失效。

基于上述问题，用户会在没有提示的情况下，认为设备出现故障。

## 初步诊断

非关键区域对焦清晰，而关键区域对焦模糊，且关键区域和非关键区域垂直距离不超过3cm，初步判断从摄像头角度来看，是景深太浅导致对焦过分敏感，设备本身的震动可能导致空间距离变化，进而原来已经调整至对焦清晰的关键区域，变得模糊。

缺乏图像质量评价体系，导致模糊的图片进入 ocr 提取流水线，导致用户不知道此时是因为摄像头需要做一些对焦/位置上的调整，进而直接需求进一步的售后。

对于 YOLO-OBB 检测到的条码/二维码区域，预处理中未包含超分辨率步骤，而模糊对于条码/二维码识别是致命的。

## 背景

摄像头：poe供电h264/h265网络摄像头，感光面积1/3英寸，定焦段25mm，定光圈f1.2，距离器具75cm。

## 认识并改善景深(DoF, Depth of Field)

$$DoF \approx \frac{2 \cdot u^2 \cdot N \cdot C}{f^2}$$

我们知道 `物距u=750mm, 焦距f=25mm, 弥散圆C=0.005mm(这个由是该尺寸CMOS的典型值), N=1.2`，计算可知景深为 10.8 mm，即景深只有 1 cm左右，非常敏感。对焦后稍微偏移就会模糊。

而假设我们将光圈变为f4，景深变为了 3.6 cm，而将光圈变为 f8，景深将变为 7.2 cm，这种情况下对焦将非常宽容，即使由于震动导致摄像头前后移动，对成像清晰度的影响也可以忽略。但是由于光圈缩小，进光量会急剧降低，因此，我们需要根据实际情况增加补光，以达到良好的曝光。

关于为什么默认的摄像头会采用f1.2的定光圈？实际很有可能是因为这个摄像头的默认使用场景是监控领域，而大光圈带来更大的进光量，便于夜晚的成像。而对于我们的场景，景深远远比进光量更重要（因为我们能够补光，而监控领域光照很难控制），所以需要特别选用小光圈（或者可调光圈）的镜头。

## 750mm的物距是合理的吗？

这里有一个镜像问题，是 "25mm的焦段是合理的吗"。虽然大多数选型会采用基于安装空间的反推，但事实上，这是完全可以通过计算评估的。

首先，假设计量器具的尺寸是 8 - 12 cm的正方形区域。那么我们摄像头的区域就要大于这个区域，但是又要保证较高的物体占比，以提高信噪比。假设cmos已经确定了（这个用业界最流行的配置就好，选型空间和重要性不如其它因素大，比如 1/3 英寸，宽4.8mm，高3.6mm），那么成像的高我们控制在 13 cm是合理的，正好可以装下器具，又留下一部分腾挪的容错。所以最终图像覆盖的区域我们可以确认为 宽 17.3 cm，高 13 cm。然后我们引入公式：

$$\frac{f}{WD} = \frac{\text{Sensor Size}}{\text{FOV}}$$

其中f为focal length，WD为working distance，然后sensor size，也就是CMOS的宽和高，FOV就是Field of View，也就是我们上面计算的最终图像覆盖的区域。由此反推，我们最终 f/wd 是 0.027 左右，无论如何选择焦段和wd，这个值是固定的。然后我们就需要根据摄像头安装的位置来决定这两个值，安装位置的决定因素是不能影响人员操作，并且远离对摄像头可能造成损害的位置（比如水源等），目前对于该仪表，常见方案是放在表位上方较近（方便人员操作，且摄像头和屏幕做了一体化封装，能够方便地进行调）和较远（防止碰头，然后常规不需要人员进行调节，这里其实也可以看出来，这种设计对景深是有要求的）两种位置，前者估算大约15cm，后者大约75cm是合理的。这里其实可以看出，实际焦距是由空间距离决定的。而空间距离完全由设备的设计思路决定。这么计算75cm选择20mm焦段是合理的，然后如果非要选择25mm焦段（假设20mm是非标），那么f/wd = 0.0333，可知图像宽度为宽 14cm，长 10.8cm，这对于任务来说也是可以接受的（因为关键区域确实被包括在了其中）。而如果是15cm位置，则选用4mm焦段是最合理的，但是4mm焦段需要考虑到畸变，镜头需要选型为低畸变镜头，不然会影响 ocr 流程，或者说引入畸变处理也会额外增加算力上的开销。

所以我们得出结论，750mm的物距是合理的，这是由我们的方案选择决定的。25mm的焦距同样是合理的，因为虽然不是我们最理想的焦段，但是它确实也可以放的下我们所关注的区域，且实现了比较大的画面占比，信噪比较好。

## 对焦环影响

对焦环需要对螺丝进行紧固，在测试阶段为了方便调整，很多时候对焦环是拧松的，然后在设备的长时间运行中，震动会导致对焦位置发生变化，特别是在景深较浅的状态下，这种影响是不可忽视的。因此也是现场排查问题的重大考虑因素。

## 对相机与镜头选型的思考

首先是镜头（Lens），我们计算过理想的焦段是20mm，但是8, 12, 16, 25, 35, 50mm才是C-Mount接口的标准焦段，对于选型，对于25mm焦段，我们计算过，完全符合我们的要求，然后16mm呢，太大了，宽接近22cm，浪费了太多画面，信噪比太低。焦段选择标准焦段，远远好于使用非标焦段，因此选择25mm焦段 C-Mount 接口的镜头。镜头分辨率5mp级别（因为我们的任务对画质没有特殊要求，工业常用标准就好），然后光圈要求可调，因为我们要求大的景深，必须要求光圈可以调节到f8级别。另外需要注意，镜头的靶面必须要大于cmos面积，否则会导致黑边。

然后相机（Camera），接口采用千兆网口（GigE），如果水表表盘宽10cm，那么在5mp（宽2592像素）画面中，表盘占据宽占比约1800左右像素，对于我们的 ocr 来说特别富裕了。实际采用 2-3mp 像素的相机是合理的。最好选择全局快门（一次成像，而卷帘快门时一行一行成像，如果物体本身运动速度快最终成像就可能扭曲）。传感器尺寸越大确实成像越好，但是考虑场景，选用一个标准大小的CMOS就可以。注意CMOS的大小需要参与焦距，景深的计算，因此需要尽早确定。

添加光源，因为光圈较小，必须添加补光，采用 LED 环形光源是工程上流行的实践，颜色呢白色就好，安装在镜头前端，且如果表盘有塑料反光，考虑相机加偏振片（原理是滤除偏振光，偏振光是光打到非金属表面形成的一种朝一个方向震动的反光，而正常的光源是向四面八方震动的），当然光源本身也需要加偏振片。


## YOLO-OBB 模型能为这件事做什么？

由于成像本身的模糊性，确实硬件是解决这个问题最迅速的手段，但算法能做什么呢？事实上，目前的文字提取是在计量器具的整张图片上进行 ocr，这导致信噪比实际依然是很低的。如果我们使用 YOLO-OBB 模型对我们关注的内容进行目标检测（比如表号），然后在对这个独立的区域进行 ocr，实际识别的成功率会高很多。因为信噪比极高，且我们可以有针对性地进行增强。至于为什么使用 OBB 框，是因为这种框更灵活，可以适应更多的场景（比如器具是45度倾斜的）。